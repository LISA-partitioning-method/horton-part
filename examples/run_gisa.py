#!/usr/bin/env python

import numpy as np
from iodata import load_one
from gbasis.evals.eval import evaluate_basis
from gbasis.wrappers import from_iodata
from horton_part import GaussianIterativeStockholderWPart, log
from utils import load_fchk
from grid import ExpRTransform, UniformInteger, BeckeWeights, MolGrid

np.set_printoptions(precision=3, suppress=True, linewidth=np.inf)
np.random.seed(44)
log.set_level(0)


def main(name):
    fn_fchk = load_fchk(name)
    mol = load_one(fn_fchk)

    # Specify the integration grid
    rtf = ExpRTransform(5e-4, 2e1, 120 - 1)
    uniform_grid = UniformInteger(120)
    rgrid = rtf.transform_1d_grid(uniform_grid)
    becke = BeckeWeights()
    grid = MolGrid.from_preset(
        mol.atnums, mol.atcoords, rgrid, "fine", becke, rotate=False, store=True
    )

    # # Get the spin-summed density matrix
    one_rdm = mol.one_rdms.get("post_scf", mol.one_rdms.get("scf"))
    basis, coord_types = from_iodata(mol)
    basis_grid = evaluate_basis(basis, grid.points, coord_type=coord_types)
    rho = np.einsum("ab,bp,ap->p", one_rdm, basis_grid, basis_grid, optimize=True)

    nelec = grid.integrate(rho)
    print("nelec = {}".format(nelec))

    kwargs = {
        "coordinates": mol.atcoords,
        "numbers": mol.atnums,
        "pseudo_numbers": mol.atnums,
        "grid": grid,
        "moldens": rho,
        "lmax": 3,
        "maxiter": 1000,
        "obj_fn_type": 0,
    }

    part = GaussianIterativeStockholderWPart(**kwargs)
    part.do_all()

    print("charges:")
    print(part.cache["charges"])
    print("cartesian multipoles:")
    print(part.cache["cartesian_multipoles"])


if __name__ == "__main__":
    for name in ["co", "clo-"]:
        main(name)
        print("#" * 80)

# obj_func_type = 1
# CO
"""
charges:
[ 0.152 -0.152]
cartesian multipoles:
[[ 0.152  0.     0.    -0.226 -4.074 -0.     0.    -4.074 -0.    -5.044  0.     0.     0.101  0.    -0.     0.     0.     0.101  0.    -0.321]
 [-0.152  0.    -0.     0.009 -3.551 -0.     0.    -3.551 -0.    -3.689 -0.     0.     0.197 -0.    -0.    -0.     0.     0.197  0.     0.416]]
"""

# ClO^-
"""
Comment: using O parameters as Cl atom proposed in the paper. (This is a bad idea, for Cl atom,
a small exponential coefficient should be used for the more diffusion part.

charges:
[ 1.971 -2.999]
cartesian multipoles:
[[   1.971   -0.       0.      -1.025   -4.434    0.      -0.      -4.434   -0.      -4.174   -0.       0.      -0.972   -0.      -0.      -0.       0.      -0.972    0.      -2.383]
 [  -2.999   -0.      -0.      -6.886  -10.8      0.       0.     -10.8      0.     -29.806   -0.      -0.     -19.466   -0.       0.      -0.      -0.     -19.466
"""

"""
Comment: using C parameters as Cl atom proposed in the paper. (This is a bad idea, for Cl atom,
a small exponential coefficient should be used for the more diffusion part.

charges:
[-0.506 -0.495]
cartesian multipoles:
[[ -0.506  -0.      0.      0.222 -10.8     0.     -0.    -10.8    -0.    -11.006   0.      0.      0.354  -0.     -0.     -0.      0.      0.354   0.      5.132]
 [ -0.495  -0.     -0.      0.084  -4.383   0.      0.     -4.383   0.     -4.177  -0.     -0.      0.293  -0.     -0.     -0.     -0.      0.293  -0.     -0.914]]
"""

"""
Comment: the result is computed with new parameters optimized as Toon's paper.

charges:
[-0.381 -0.62 ]
cartesian multipoles:
[[ -0.381  -0.      0.     -0.195 -10.482   0.     -0.    -10.482  -0.     -9.707  -0.      0.     -0.457  -0.     -0.     -0.      0.     -0.457   0.      1.044]
 [ -0.62   -0.     -0.      0.094  -4.701   0.      0.     -4.701   0.     -4.078  -0.     -0.      0.063  -0.     -0.     -0.     -0.      0.063  -0.     -0.542]]
"""

# C5H12
"""
charges:
[ 0.493 -0.659 -0.659 -0.659 -0.659  0.178  0.178  0.178  0.178  0.178  0.178  0.178  0.178  0.178  0.178  0.178  0.178]
cartesian multipoles:
[[ 0.493  0.    -0.     0.    -3.265 -0.     0.    -3.265 -0.    -3.265  0.    -0.     0.     0.    -0.152  0.    -0.     0.    -0.     0.   ]
 [-0.659 -0.055 -0.055 -0.055 -5.602 -0.004 -0.004 -5.602 -0.004 -5.602 -0.462 -0.091 -0.091 -0.091  0.439 -0.091 -0.462 -0.091 -0.091 -0.462]
 [-0.659  0.055  0.055 -0.055 -5.602 -0.004  0.004 -5.602  0.004 -5.602  0.462  0.091 -0.091  0.091  0.439  0.091  0.462 -0.091  0.091 -0.462]
 [-0.659  0.055 -0.055  0.055 -5.602  0.004 -0.004 -5.602  0.004 -5.602  0.462 -0.091  0.091  0.091  0.439  0.091 -0.462  0.091 -0.091  0.462]
 [-0.659 -0.055  0.055  0.055 -5.602  0.004  0.004 -5.602 -0.004 -5.602 -0.462  0.091  0.091 -0.091  0.439 -0.091  0.462  0.091  0.091  0.462]
 [ 0.178  0.015 -0.022  0.015 -0.438  0.008 -0.003 -0.435  0.008 -0.438 -0.027 -0.001 -0.006 -0.009  0.007 -0.006  0.004 -0.009 -0.001 -0.027]
 [ 0.178  0.015  0.015 -0.022 -0.438 -0.003  0.008 -0.438  0.008 -0.435 -0.027 -0.006 -0.001 -0.006  0.007 -0.009 -0.027 -0.001 -0.009  0.004]
 [ 0.178 -0.022  0.015  0.015 -0.435  0.008  0.008 -0.438 -0.003 -0.438  0.004 -0.009 -0.009 -0.001  0.007 -0.001 -0.027 -0.006 -0.006 -0.027]
 [ 0.178 -0.015 -0.015 -0.022 -0.438 -0.003 -0.008 -0.438 -0.008 -0.435  0.027  0.006 -0.001  0.006  0.007  0.009  0.027 -0.001  0.009  0.004]
 [ 0.178  0.022 -0.015  0.015 -0.435  0.008 -0.008 -0.438  0.003 -0.438 -0.004  0.009 -0.009  0.001  0.007  0.001  0.027 -0.006  0.006 -0.027]
 [ 0.178 -0.015  0.022  0.015 -0.438  0.008  0.003 -0.435 -0.008 -0.438  0.027  0.001 -0.006  0.009  0.007  0.006 -0.004 -0.009  0.001 -0.027]
 [ 0.178 -0.015 -0.022 -0.015 -0.438 -0.008 -0.003 -0.435 -0.008 -0.438  0.027 -0.001  0.006  0.009  0.007  0.006  0.004  0.009 -0.001  0.027]
 [ 0.178 -0.015  0.015  0.022 -0.438  0.003  0.008 -0.438 -0.008 -0.435  0.027 -0.006  0.001  0.006  0.007  0.009 -0.027  0.001 -0.009 -0.004]
 [ 0.178  0.022  0.015 -0.015 -0.435 -0.008  0.008 -0.438  0.003 -0.438 -0.004 -0.009  0.009  0.001  0.007  0.001 -0.027  0.006 -0.006  0.027]
 [ 0.178  0.015 -0.015  0.022 -0.438  0.003 -0.008 -0.438  0.008 -0.435 -0.027  0.006  0.001 -0.006  0.007 -0.009  0.027  0.001  0.009 -0.004]
 [ 0.178 -0.022 -0.015 -0.015 -0.435 -0.008 -0.008 -0.438 -0.003 -0.438  0.004  0.009  0.009 -0.001  0.007 -0.001  0.027  0.006  0.006  0.027]
 [ 0.178  0.015  0.022 -0.015 -0.438 -0.008  0.003 -0.435  0.008 -0.438 -0.027  0.001  0.006 -0.009  0.007 -0.006 -0.004  0.009  0.001  0.027]]
"""

# C6H6
"""
charges:
[-0.145 -0.147 -0.147 -0.147 -0.147 -0.145  0.146  0.146  0.146  0.146  0.146  0.146]
cartesian multipoles:
[[-0.145 -0.082  0.016 -0.    -4.546 -0.011  0.    -4.599 -0.    -4.514 -0.864  0.203 -0.     0.028 -0.    -0.387 -0.034  0.     0.077 -0.   ]
 [-0.147 -0.027  0.08   0.    -4.6   -0.017 -0.    -4.554  0.    -4.516  0.033  0.042  0.    -0.306 -0.    -0.127  0.77  -0.     0.373 -0.   ]
 [-0.147 -0.056 -0.063  0.    -4.583  0.028 -0.    -4.574  0.    -4.517 -0.186 -0.321 -0.    -0.38   0.    -0.261 -0.319 -0.    -0.295 -0.   ]
 [-0.147  0.056  0.063 -0.    -4.583  0.028 -0.    -4.574 -0.    -4.517  0.186  0.321 -0.     0.38  -0.     0.261  0.319  0.     0.295  0.   ]
 [-0.147  0.027 -0.08   0.    -4.6   -0.017 -0.    -4.554  0.    -4.516 -0.033 -0.042  0.     0.306 -0.     0.127 -0.77   0.    -0.373  0.   ]
 [-0.145  0.082 -0.016  0.    -4.546 -0.011  0.    -4.599  0.    -4.514  0.864 -0.203 -0.    -0.028 -0.     0.387  0.034  0.    -0.077 -0.   ]
 [ 0.146  0.037 -0.007 -0.    -0.485  0.005 -0.    -0.459 -0.    -0.484 -0.042  0.006 -0.    -0.006 -0.    -0.012  0.003  0.     0.002 -0.   ]
 [ 0.146  0.012 -0.036 -0.    -0.461  0.009  0.    -0.483 -0.    -0.484 -0.006  0.008 -0.    -0.01  -0.    -0.004  0.039 -0.     0.012 -0.   ]
 [ 0.146  0.025  0.029 -0.    -0.47  -0.014 -0.    -0.474  0.    -0.484 -0.019 -0.013  0.    -0.014  0.    -0.008 -0.024  0.    -0.009 -0.   ]
 [ 0.146 -0.025 -0.029  0.    -0.47  -0.014  0.    -0.474 -0.    -0.484  0.019  0.013  0.     0.014 -0.     0.008  0.024  0.     0.009  0.   ]
 [ 0.146 -0.012  0.036  0.    -0.461  0.009 -0.    -0.483 -0.    -0.484  0.006 -0.008  0.     0.01   0.     0.004 -0.039  0.    -0.012  0.   ]
 [ 0.146 -0.037  0.007 -0.    -0.485  0.005 -0.    -0.459  0.    -0.484  0.042 -0.006  0.     0.006 -0.     0.012 -0.003  0.    -0.002  0.   ]]
"""
